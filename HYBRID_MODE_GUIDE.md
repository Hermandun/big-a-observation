# 混合模式架构说明

## 🎯 设计理念

**兼顾速度与质量**：一级分析使用V3快速模型持续监控，二级分析使用R1深度模型生成高质量推荐。

## 📊 工作流程

```
新闻抓取
    ↓
【一级分析 - DeepSeek-V3】⚡ 5-10秒
    ↓
影响判断: 是/否
    ↓
    ├─ 否 → 继续监控下一条新闻
    │
    └─ 是 → 筛选候选股票
            ↓
            加入R1分析队列 📥
            ↓
            继续监控新新闻（不等待）
            ↓
【二级分析 - DeepSeek-R1】🔬 30-120秒
            ↓
            生成操作建议
            ↓
            显示推荐结果
```

## 🔧 技术实现

### 1. 双轨并行机制

| 轨道 | 模型 | 速度 | 阻塞行为 |
|------|------|------|---------|
| 一级分析 | DeepSeek-V3 | 5-10秒 | 不阻塞，持续监控 |
| 二级分析 | DeepSeek-R1 | 30-120秒 | 队列化，一个完成再处理下一个 |

### 2. 队列管理

```python
# Session State 变量
- level2_queue: []              # R1分析任务队列
- is_level2_analyzing: False    # R1分析状态标记
- analysis_start_time: None     # 分析开始时间

# 任务结构
task = {
    'title': '新闻标题',
    'sectors': ['板块1', '板块2'],
    'reason': '影响原因',
    'candidates': [...],  # 候选股票
    'created_time': '18:30:45',
    'nid': '新闻ID'
}
```

### 3. 执行逻辑

#### 每10秒自动刷新时：

1. **检查R1队列**
   - 如果有任务且未在分析 → 取出第一个任务处理
   - 如果正在分析 → 更新等待时间显示

2. **执行一级分析**
   - 抓取最新新闻
   - 调用V3模型（5-10秒）
   - 如果有影响 → 加入R1队列
   - 继续下一轮（不等待R1完成）

3. **并发处理**
   - V3一级分析：每10秒处理一条新闻
   - R1二级分析：后台异步处理队列任务

## 📱 用户界面

### 状态显示

#### 正常监控
```
用户：admin | 自动刷新：每10秒 | 刷新次数: 42
🔧 一级: V3快速 | 二级: R1深度 | R1队列: 0
```

#### R1分析中
```
⏳ R1二级分析中... 已等待 45 秒
💡 R1模型正在进行深度推理，一级分析（V3）将继续监控新闻。
```

#### 有队列等待
```
📥 R1分析队列: 3 个任务等待处理
```

### 推荐结果标记

```
🎯 推荐 #1 - 18:35:42 [🔬 R1深度]
  新闻: 央行降息50个基点...
  板块: 房地产, 银行
  🤖 分析模型: DeepSeek-R1
  
  📋 整体策略: ...
  ✅ 推荐股票: ...
```

## ⚡ 性能优势

| 场景 | 传统全R1模式 | 混合模式 |
|------|-------------|---------|
| 发现无影响新闻 | 30-120秒/条 | 5-10秒/条 |
| 发现有影响新闻 | 60-240秒/条 | 5-10秒(一级) + 后台30-120秒(二级) |
| 10分钟可监控 | 5-20条 | 60-120条 |
| 用户等待感 | 长时间空白 | 快速响应 |

## 🎨 用户体验

### 优势
1. ✅ **快速响应**：一级分析5-10秒，无明显等待
2. ✅ **持续监控**：不会因R1推理而错过新闻
3. ✅ **高质量推荐**：重要新闻由R1深度分析
4. ✅ **透明可见**：队列长度、分析进度实时显示
5. ✅ **自动降级**：R1失败不影响一级分析继续进行

### 工作流示例

```
18:30:00 - 抓取新闻：央行降息
18:30:05 - V3一级分析完成：有影响 → 加入R1队列
18:30:05 - 继续监控下一条新闻

18:30:10 - 抓取新闻：某公司年报
18:30:15 - V3一级分析完成：无影响 → 跳过
18:30:15 - 继续监控...

18:30:20 - R1开始分析降息新闻（队列任务1）
18:30:25 - 抓取新闻：芯片突破
18:30:30 - V3一级分析完成：有影响 → 加入R1队列（队列长度:1）

18:31:30 - R1完成降息分析（用时70秒）
18:31:30 - R1开始分析芯片新闻（队列任务2）
```

## 🔍 日志示例

```
[18:31:30] ✅ R1二级分析完成
[18:31:30] 🚀 开始R1二级分析 (创建于 18:30:30)
[18:30:45] ⏳ R1二级分析中... 已等待 45 秒 (一级分析继续进行)
[18:30:30] 📥 已加入R1二级分析队列 (队列长度: 1)
[18:30:30] ✅ 筛选了 5 只候选股票
[18:30:30] 📊 影响判断: 是
[18:30:25] 🤖 调用DeepSeek一级分析(V3快速模型)...
```

## 🚀 扩展可能

### 未来优化方向

1. **智能队列优先级**
   - 按新闻重要性排序
   - 紧急新闻优先处理

2. **批量分析**
   - 多个相似新闻合并分析
   - 降低R1调用次数

3. **缓存机制**
   - 相似新闻复用分析结果
   - 板块影响历史参考

4. **用户自定义**
   - 选择哪些板块使用R1
   - 设置R1队列长度上限

## 📝 总结

混合模式通过**职责分离**实现了最佳平衡：
- V3负责快速筛选（覆盖面广）
- R1负责深度分析（质量保证）
- 队列机制保证有序处理
- 状态透明化提升用户体验

这种架构既保证了**实时性**，又不牺牲**分析质量**，是生产环境的最佳实践。
